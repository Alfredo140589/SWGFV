{% extends "core/layout.html" %}

{% block title %}SWGFV - Modificaci√≥n de Usuarios{% endblock %}

{% block page_content %}
<div class="card shadow-sm bg-glass">
  <div class="card-body p-3 p-md-4">

    <h2 class="text-center mb-4" style="color: var(--swgfv-primary); font-weight: 800;">
      Modificaci√≥n de Usuarios
    </h2>

    {% if messages %}
      <div class="mb-3">
        {% for message in messages %}
          <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
          </div>
        {% endfor %}
      </div>
    {% endif %}

    <!-- BUSQUEDA -->
    <form method="GET" class="mb-4">
      <div class="row g-3">
        <div class="col-12 col-md-3">
          <label class="form-label fw-bold" style="color: var(--swgfv-primary);">ID</label>
          <input type="text" name="id" value="{{ q_id }}" class="form-control" placeholder="ID Usuario">
        </div>

        <div class="col-12 col-md-3">
          <label class="form-label fw-bold" style="color: var(--swgfv-primary);">Nombre</label>
          <input type="text" name="nombre" value="{{ q_nombre }}" class="form-control" placeholder="Nombre">
        </div>

        <div class="col-12 col-md-3">
          <label class="form-label fw-bold" style="color: var(--swgfv-primary);">Apellido Paterno</label>
          <input type="text" name="ap" value="{{ q_ap }}" class="form-control" placeholder="Apellido Paterno">
        </div>

        <div class="col-12 col-md-3">
          <label class="form-label fw-bold" style="color: var(--swgfv-primary);">Apellido Materno</label>
          <input type="text" name="am" value="{{ q_am }}" class="form-control" placeholder="Apellido Materno">
        </div>
      </div>

      <div class="d-flex flex-wrap justify-content-center gap-2 mt-3">
        <button type="submit" class="btn btn-swgfv px-4">Buscar</button>
        <a href="{% url 'core:gestion_usuarios_modificacion' %}" class="btn btn-outline-secondary px-4">Limpiar</a>
      </div>
    </form>

    <!-- LISTA (solo si hubo b√∫squeda) -->
    {% if mostrar_lista %}
      <div class="table-responsive mb-4">
        <table class="table table-bordered table-striped align-middle">
          <thead>
            <tr>
              <th>ID</th>
              <th>Nombre</th>
              <th>Correo</th>
              <th>Tipo</th>
              <th>Activo</th>
              <th>Acci√≥n</th>
            </tr>
          </thead>
          <tbody>
            {% for u in usuarios %}
            <tr>
              <td>{{ u.ID_Usuario }}</td>
              <td>{{ u.Nombre }} {{ u.Apellido_Paterno }} {{ u.Apellido_Materno }}</td>
              <td style="word-break: break-word;">{{ u.Correo_electronico }}</td>
              <td>{{ u.Tipo }}</td>
              <td>
                {% if u.Activo %}
                  <span class="badge text-bg-success">S√≠</span>
                {% else %}
                  <span class="badge text-bg-danger">No</span>
                {% endif %}
              </td>
              <td>
                <a class="btn btn-sm btn-primary"
                   href="{% url 'core:gestion_usuarios_modificacion' %}?id={{ u.ID_Usuario }}">
                  Seleccionar
                </a>
              </td>
            </tr>
            {% empty %}
            <tr><td colspan="6" class="text-center">No hay resultados.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="alert alert-info">
        Realiza una b√∫squeda para mostrar usuarios.
      </div>
    {% endif %}

    <!-- EDICION / LECTURA -->
    {% if seleccionado and form %}
      <hr class="mb-4">

      <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-2 mb-3">
        <h5 class="m-0" style="color: var(--swgfv-primary); font-weight: 800;">
          Usuario seleccionado: ID {{ seleccionado.ID_Usuario }} ‚Äî {{ seleccionado.Correo_electronico }}
        </h5>

        {% if not edit_mode %}
          <a class="btn btn-outline-primary btn-sm"
             href="{% url 'core:gestion_usuarios_modificacion' %}?id={{ seleccionado.ID_Usuario }}&edit=1">
            ‚úèÔ∏è Editar
          </a>
        {% else %}
          <a class="btn btn-outline-secondary btn-sm"
             href="{% url 'core:gestion_usuarios_modificacion' %}?id={{ seleccionado.ID_Usuario }}">
            üëÅÔ∏è Modo lectura
          </a>
        {% endif %}
      </div>

      <form method="POST" novalidate>
        {% csrf_token %}

        {% if form.non_field_errors %}
          <div class="alert alert-danger">
            {{ form.non_field_errors }}
          </div>
        {% endif %}

        <!-- fieldset deshabilita TODO si no estamos en edit_mode -->
        <fieldset {% if not edit_mode %}disabled{% endif %}>
          <div class="row g-3">
            <div class="col-12 col-md-4">
              <label class="form-label fw-bold" style="color: var(--swgfv-primary);">Nombre</label>
              {{ form.Nombre }}
              {% if form.Nombre.errors %}<div class="text-danger">{{ form.Nombre.errors }}</div>{% endif %}
            </div>

            <div class="col-12 col-md-4">
              <label class="form-label fw-bold" style="color: var(--swgfv-primary);">Apellido Paterno</label>
              {{ form.Apellido_Paterno }}
              {% if form.Apellido_Paterno.errors %}<div class="text-danger">{{ form.Apellido_Paterno.errors }}</div>{% endif %}
            </div>

            <div class="col-12 col-md-4">
              <label class="form-label fw-bold" style="color: var(--swgfv-primary);">Apellido Materno</label>
              {{ form.Apellido_Materno }}
              {% if form.Apellido_Materno.errors %}<div class="text-danger">{{ form.Apellido_Materno.errors }}</div>{% endif %}
            </div>

            <div class="col-12 col-md-4">
              <label class="form-label fw-bold" style="color: var(--swgfv-primary);">Tel√©fono</label>
              {{ form.Telefono }}
              {% if form.Telefono.errors %}<div class="text-danger">{{ form.Telefono.errors }}</div>{% endif %}
            </div>

            <div class="col-12 col-md-4">
              <label class="form-label fw-bold" style="color: var(--swgfv-primary);">Correo electr√≥nico</label>
              {{ form.Correo_electronico }}
              {% if form.Correo_electronico.errors %}<div class="text-danger">{{ form.Correo_electronico.errors }}</div>{% endif %}
            </div>

            <div class="col-12 col-md-4">
              <label class="form-label fw-bold" style="color: var(--swgfv-primary);">Tipo</label>
              {{ form.Tipo }}
              {% if form.Tipo.errors %}<div class="text-danger">{{ form.Tipo.errors }}</div>{% endif %}
            </div>

            <div class="col-12">
              <div class="form-check">
                {{ form.Activo }}
                <label class="form-check-label fw-bold" style="color: var(--swgfv-primary);">Activo</label>
                {% if form.Activo.errors %}<div class="text-danger">{{ form.Activo.errors }}</div>{% endif %}
              </div>
            </div>

            <div class="col-12 col-md-6">
              <label class="form-label fw-bold" style="color: var(--swgfv-primary);">Nueva contrase√±a (opcional)</label>
              {{ form.new_password }}
              {% if form.new_password.errors %}<div class="text-danger">{{ form.new_password.errors }}</div>{% endif %}
            </div>

            <div class="col-12 col-md-6">
              <label class="form-label fw-bold" style="color: var(--swgfv-primary);">Confirmar nueva contrase√±a</label>
              {{ form.new_password_confirm }}
              {% if form.new_password_confirm.errors %}<div class="text-danger">{{ form.new_password_confirm.errors }}</div>{% endif %}
            </div>
          </div>
        </fieldset>

        <div class="d-flex flex-wrap justify-content-center gap-2 mt-4">
          <a href="{% url 'core:gestion_usuarios_modificacion' %}" class="btn btn-outline-secondary px-4">Cancelar</a>

          {% if edit_mode %}
            <button type="submit" class="btn btn-swgfv px-4">Guardar cambios</button>
          {% else %}
            <button type="button" class="btn btn-swgfv px-4" disabled title="Presiona ‚úèÔ∏è Editar para habilitar">
              Guardar cambios
            </button>
          {% endif %}
{% if not seleccionado.Activo %}
  <button type="submit" name="action" value="activate" class="btn btn-success px-4"
          onclick="return confirm('¬øDeseas activar este usuario?');">
    Activar
  </button>
{% endif %}

          <button type="submit" name="action" value="deactivate" class="btn btn-warning px-4"
                  onclick="return confirm('¬øSeguro que deseas desactivar este usuario?');">
            Desactivar
          </button>

          <button type="submit" name="action" value="delete" class="btn btn-danger px-4"
                  onclick="return confirm('‚ö†Ô∏è Esto eliminar√° el usuario PERMANENTEMENTE. ¬øDeseas continuar?');">
            Eliminar
          </button>
        </div>
      </form>
    {% endif %}

  </div>
</div>
{% endblock %}
