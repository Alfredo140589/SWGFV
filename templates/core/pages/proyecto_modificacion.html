{% extends "core/layout.html" %}

{% block title %}SWGFV - Modificaci√≥n de Proyectos{% endblock %}

{% block page_content %}
<div class="card shadow-sm bg-glass">
  <div class="card-body p-3 p-md-4">

    <h2 class="text-center mb-4" style="color: var(--swgfv-primary); font-weight: 800;">
      Modificaci√≥n de Proyectos
    </h2>

    {% if messages %}
      <div class="mb-3">
        {% for message in messages %}
          <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
          </div>
        {% endfor %}
      </div>
    {% endif %}

    <!-- B√öSQUEDA -->
    <form method="GET" class="mb-4">
      <div class="row g-3">

        <div class="col-12 col-md-2">
          <label class="form-label fw-bold" style="color: var(--swgfv-primary);">ID</label>
          <input type="text" name="id" value="{{ q_id }}" class="form-control" placeholder="ID">
        </div>

        <div class="col-12 col-md-4">
          <label class="form-label fw-bold" style="color: var(--swgfv-primary);">Nombre del proyecto</label>
          <input type="text" name="nombre" value="{{ q_nombre }}" class="form-control" placeholder="Nombre">
        </div>

        <div class="col-12 col-md-3">
          <label class="form-label fw-bold" style="color: var(--swgfv-primary);">Empresa</label>
          <input type="text" name="empresa" value="{{ q_empresa }}" class="form-control" placeholder="Empresa">
        </div>

        {% if es_admin %}
        <div class="col-12 col-md-3">
          <label class="form-label fw-bold" style="color: var(--swgfv-primary);">Usuario (correo)</label>
          <input type="text" name="usuario" value="{{ q_usuario }}" class="form-control" placeholder="correo@...">
        </div>
        {% endif %}

      </div>

      <div class="d-flex flex-wrap justify-content-center gap-2 mt-3">
        <button type="submit" class="btn btn-swgfv px-4">Buscar</button>
        <a href="{% url 'core:proyecto_modificacion' %}" class="btn btn-outline-secondary px-4">Limpiar</a>
      </div>
    </form>

    <!-- LISTA -->
    {% if mostrar_lista %}
      <div class="table-responsive mb-4">
        <table class="table table-bordered table-striped align-middle">
          <thead>
            <tr>
              <th style="width:80px;">ID</th>
              <th>Proyecto</th>
              <th>Empresa</th>
              <th>Voltaje</th>
              <th>Fases</th>
              {% if es_admin %}<th>Usuario</th>{% endif %}
              <th style="width:120px;">Acci√≥n</th>
            </tr>
          </thead>
          <tbody>
            {% for p in proyectos %}
            <tr>
              <td>{{ p.id }}</td>
              <td>{{ p.Nombre_Proyecto }}</td>
              <td>{{ p.Nombre_Empresa|default:"‚Äî" }}</td>
              <td>{{ p.Voltaje_Nominal }}</td>
              <td>{{ p.Numero_Fases }}</td>
              {% if es_admin %}<td style="word-break: break-word;">{{ p.ID_Usuario.Correo_electronico }}</td>{% endif %}
              <td>
                <a class="btn btn-sm btn-primary"
                   href="{% url 'core:proyecto_modificacion' %}?id={{ p.id }}">
                  Seleccionar
                </a>
              </td>
            </tr>
            {% empty %}
            <tr><td colspan="{% if es_admin %}7{% else %}6{% endif %}" class="text-center">No hay resultados.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="alert alert-info">
        Realiza una b√∫squeda para mostrar proyectos.
      </div>
    {% endif %}

    <!-- EDICI√ìN / LECTURA -->
    {% if seleccionado and form %}
      <hr class="mb-4">

      <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-2 mb-3">
        <h5 class="m-0" style="color: var(--swgfv-primary); font-weight: 800;">
          Proyecto seleccionado: ID {{ seleccionado.id }} ‚Äî {{ seleccionado.Nombre_Proyecto }}
        </h5>

        {% if not edit_mode %}
          <a class="btn btn-outline-primary btn-sm"
             href="{% url 'core:proyecto_modificacion' %}?id={{ seleccionado.id }}&edit=1">
            ‚úèÔ∏è Editar
          </a>
        {% else %}
          <a class="btn btn-outline-secondary btn-sm"
             href="{% url 'core:proyecto_modificacion' %}?id={{ seleccionado.id }}">
            üëÅÔ∏è Modo lectura
          </a>
        {% endif %}
      </div>

      <form method="POST" novalidate>
        {% csrf_token %}

        {% if form.non_field_errors %}
          <div class="alert alert-danger">{{ form.non_field_errors }}</div>
        {% endif %}

        <fieldset {% if not edit_mode %}disabled{% endif %}>
          <div class="row g-3">

            <div class="col-12 col-md-6">
              <label class="form-label fw-bold" style="color: var(--swgfv-primary);">Nombre del proyecto</label>
              {{ form.Nombre_Proyecto }}
              {% if form.Nombre_Proyecto.errors %}<div class="text-danger">{{ form.Nombre_Proyecto.errors }}</div>{% endif %}
            </div>

            <div class="col-12 col-md-6">
              <label class="form-label fw-bold" style="color: var(--swgfv-primary);">Empresa (opcional)</label>
              {{ form.Nombre_Empresa }}
              {% if form.Nombre_Empresa.errors %}<div class="text-danger">{{ form.Nombre_Empresa.errors }}</div>{% endif %}
            </div>

            <div class="col-12">
              <label class="form-label fw-bold" style="color: var(--swgfv-primary);">Direcci√≥n</label>
              {{ form.Direccion }}
              {% if form.Direccion.errors %}<div class="text-danger">{{ form.Direccion.errors }}</div>{% endif %}
            </div>

            <div class="col-12 col-md-6">
              <label class="form-label fw-bold" style="color: var(--swgfv-primary);">Coordenadas</label>
              {{ form.Coordenadas }}
              {% if form.Coordenadas.errors %}<div class="text-danger">{{ form.Coordenadas.errors }}</div>{% endif %}
            </div>

            <div class="col-12 col-md-3">
              <label class="form-label fw-bold" style="color: var(--swgfv-primary);">Voltaje nominal</label>
              {{ form.Voltaje_Nominal }}
              {% if form.Voltaje_Nominal.errors %}<div class="text-danger">{{ form.Voltaje_Nominal.errors }}</div>{% endif %}
            </div>

            <div class="col-12 col-md-3">
              <label class="form-label fw-bold" style="color: var(--swgfv-primary);">N√∫mero de fases</label>
              {{ form.Numero_Fases }}
              {% if form.Numero_Fases.errors %}<div class="text-danger">{{ form.Numero_Fases.errors }}</div>{% endif %}
            </div>

          </div>
        </fieldset>

        <div class="d-flex flex-wrap justify-content-center gap-2 mt-4">
          <a href="{% url 'core:proyecto_modificacion' %}" class="btn btn-outline-secondary px-4">Cancelar</a>

          {% if edit_mode %}
            <button type="submit" class="btn btn-swgfv px-4">Guardar cambios</button>
          {% else %}
            <button type="button" class="btn btn-swgfv px-4" disabled title="Presiona ‚úèÔ∏è Editar para habilitar">
              Guardar cambios
            </button>
          {% endif %}
        </div>
      </form>
    {% endif %}

  </div>
</div>
{% endblock %}
