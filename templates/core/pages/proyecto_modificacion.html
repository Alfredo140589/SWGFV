{% extends "core/layout.html" %}

{% block title %}SWGFV - Modificación de Proyecto{% endblock %}

{% block page_content %}
<div class="card shadow-sm bg-glass">
  <div class="card-body p-3 p-md-4">

    <h2 class="text-center mb-4" style="color: var(--swgfv-primary); font-weight: 800;">
      Modificación de Proyecto
    </h2>

    <!-- BUSQUEDA -->
    <form method="GET" class="mb-4">
      <div class="row g-3">
        <div class="col-12 col-md-3">
          <label class="form-label fw-bold">ID</label>
          <input type="text" name="id" value="{{ q_id }}" class="form-control" placeholder="ID Proyecto">
        </div>

        <div class="col-12 col-md-4">
          <label class="form-label fw-bold">Nombre del proyecto</label>
          <input type="text" name="nombre" value="{{ q_nombre }}" class="form-control" placeholder="Proyecto">
        </div>

        <div class="col-12 col-md-5">
          <label class="form-label fw-bold">Empresa</label>
          <input type="text" name="empresa" value="{{ q_empresa }}" class="form-control" placeholder="Empresa">
        </div>
      </div>

      <div class="d-flex justify-content-center gap-2 mt-3">
        <button type="submit" class="btn btn-swgfv px-4">Buscar</button>
        <a href="{% url 'core:proyecto_modificacion' %}" class="btn btn-outline-secondary px-4">Limpiar</a>
      </div>
    </form>

    <!-- LISTA (solo después de búsqueda) -->
    {% if mostrar_lista %}
      <div class="table-responsive mb-4">
        <table class="table table-bordered table-striped align-middle">
          <thead>
            <tr>
              <th>ID</th>
              <th>Proyecto</th>
              <th>Empresa</th>
              <th>Usuario</th>
              <th>Acción</th>
            </tr>
          </thead>
          <tbody>
            {% for p in proyectos %}
            <tr>
              <td>{{ p.id }}</td>
              <td>{{ p.Nombre_Proyecto }}</td>
              <td>{{ p.Nombre_Empresa|default:"—" }}</td>
              <td>{{ p.ID_Usuario.Correo_electronico }}</td>
              <td>
                <a class="btn btn-sm btn-primary"
                   href="{% url 'core:proyecto_modificacion' %}?id={{ p.id }}">
                  Seleccionar
                </a>
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="5" class="text-center">Sin resultados</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="alert alert-info">
        Realiza una búsqueda para mostrar proyectos.
      </div>
    {% endif %}

    <!-- FORMULARIO DE EDICIÓN -->
    {% if seleccionado and form %}
      <hr class="my-4">

      <h5 class="mb-3" style="color: var(--swgfv-primary); font-weight: 800;">
        Editando: ID {{ seleccionado.id }} — {{ seleccionado.Nombre_Proyecto }}
      </h5>

      <form method="POST" novalidate>
        {% csrf_token %}
        <!-- IMPORTANTÍSIMO: asegura que POST sepa qué proyecto editar/eliminar -->
        <input type="hidden" name="selected_id" value="{{ seleccionado.id }}">

        <div class="row g-3">
          <div class="col-12 col-md-6">
            <label class="form-label fw-bold">Nombre del proyecto</label>
            {{ form.Nombre_Proyecto }}
            {% if form.Nombre_Proyecto.errors %}<div class="text-danger">{{ form.Nombre_Proyecto.errors }}</div>{% endif %}
          </div>

          <div class="col-12 col-md-6">
            <label class="form-label fw-bold">Empresa</label>
            {{ form.Nombre_Empresa }}
            {% if form.Nombre_Empresa.errors %}<div class="text-danger">{{ form.Nombre_Empresa.errors }}</div>{% endif %}
          </div>

          <div class="col-12">
            <label class="form-label fw-bold">Dirección</label>
            {{ form.Direccion }}
            {% if form.Direccion.errors %}<div class="text-danger">{{ form.Direccion.errors }}</div>{% endif %}
          </div>

          <div class="col-12 col-md-6">
            <label class="form-label fw-bold">Coordenadas</label>
            {{ form.Coordenadas }}
            {% if form.Coordenadas.errors %}<div class="text-danger">{{ form.Coordenadas.errors }}</div>{% endif %}
          </div>

          <div class="col-12 col-md-3">
            <label class="form-label fw-bold">Voltaje nominal</label>
            {{ form.Voltaje_Nominal }}
            {% if form.Voltaje_Nominal.errors %}<div class="text-danger">{{ form.Voltaje_Nominal.errors }}</div>{% endif %}
          </div>

          <div class="col-12 col-md-3">
            <label class="form-label fw-bold">Número de fases</label>
            {{ form.Numero_Fases }}
            {% if form.Numero_Fases.errors %}<div class="text-danger">{{ form.Numero_Fases.errors }}</div>{% endif %}
          </div>
        </div>

        <div class="d-flex flex-wrap justify-content-center gap-2 mt-4">
          <a href="{% url 'core:proyecto_modificacion' %}" class="btn btn-outline-secondary px-4">
            Cancelar
          </a>

          <button type="submit" class="btn btn-swgfv px-4">
            Guardar cambios
          </button>

          <button type="submit" name="action" value="delete"
                  class="btn btn-danger px-4"
                  onclick="return confirm('¿Seguro que deseas eliminar este proyecto? Esta acción no se puede deshacer.');">
            Eliminar
          </button>
        </div>
      </form>
    {% endif %}

  </div>
</div>
{% endblock %}
